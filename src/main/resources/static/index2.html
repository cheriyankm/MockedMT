<!DOCTYPE html>
<html>
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<link rel="stylesheet" type="text/css" href="mockStyle.css">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<body>

	<div ng-app="myApp" ng-controller="myCtrl" class="container">
		<nav class="navbar navbar-default">
			<div class="container-fluid">
				<div class="navbar-header">
					<a class="navbar-brand" href="index.html">CherryMock</a>
				</div>
				<ul class="nav navbar-nav">
					<li><a href="index.html">Home</a></li>
					<li><a href="index1.html">excel upload</a></li>
					<li class="active"><a href="index2.html">Manual entry</a></li>
				</ul>
			</div>
		</nav>
		<font
			ng-hide="mockedResponses.length==0">Use <b>http://localhost:2883/mockit</b>
			as Base URL
		</font><br> <font ng-show="flag">{{msg}}</font>
		<form>
			<table class="table">
				<tr>
					<td>API</td>
					<td>Request method</td>
					<td>Status code</td>
					<td>Response</td>
				</tr>
				<tr>
					<td><input type="text" ng-model="apiDetails.api"
						placeholder="API" required="required"></td>
					<td><select ng-model="apiDetails.requestMethod"
						ng-options="x for x in allMethods" required="required"
						placeholder="Request Method"></select></td>
					<td><input type="number" ng-model="apiDetails.statusCode"
						placeholder="status code" required="required"></td>
					<td><textarea ng-model="apiDetails.response"
							placeholder="Response" required="required"></textarea></td>
					<td><input type="submit" class="btn btn-success" value="Add"
						ng-click="addNewApi()"></td>
				</tr>
			</table>
		</form>
		<table class="table table-striped">
			<tr>
				<td></td>
				<td>API</td>
				<td>Request method</td>
				<td>Status code</td>
				<td>Response</td>
			</tr>
			<tr ng-repeat="x in mockedResponses">
				<td><button class="btn btn-danger" ng-click="editApiDetails(x)">edit/delete</button></td>
				<td>{{ x.api }}</td>
				<td>{{ x.requestMethod }}</td>
				<td>{{ x.statusCode }}</td>
				<td>{{ x.response }}</td>
			</tr>
		</table>
	</div>

	<script>
		var app = angular.module('myApp', []);
		app.controller('myCtrl', function($scope, $http, $window) {
			$scope.customStyle = {};
			$scope.apiDetails = {};
			$scope.mockedResponses = [];
			$scope.fileDisabled = true;
			$scope.allMethods = ["POST","GET","PUT","DELTE","PATCH"];
			$http.get("/mitek/getFile").then(function(response) {
				$scope.file = response.data;
				if ($scope.file == "No file selected") {
					$scope.turnGreen();
				} else {
					$scope.turnBlue();
				}
			});

			$scope.turnGreen = function() {
				$scope.customStyle.style = {
					"color" : "green"
				};
			}

			$scope.turnBlue = function() {
				$scope.customStyle.style = {
					"color" : "blue"
				};
			}

			$scope.changeFileName = function() {
				$scope.fileDisabled = false;
			}

			$http.get("/mitek/response/mocked/cache").then(function(response) {
				console.log("response is --> "+response.data)
				$scope.mockedResponses = response.data;

			});
			
			$scope.log = []
			
			$scope.addNewApi = function(){
				$scope.msg = "";
				$scope.flag = false;
				
				console.log($scope.apiDetails);
				if(Object.keys($scope.apiDetails).length < 4){
					$scope.flag = true;
					$scope.msg = "fill all fields!";
				}
				
				angular.forEach($scope.mockedResponses, function(a){
					if(a.api == $scope.apiDetails.api && a.requestMethod == $scope.apiDetails.requestMethod){
						$scope.flag = true;
						$scope.msg = "Duplicate entry";
					}
				});
				
				if(!$scope.flag){
				angular.forEach($scope.apiDetails, function(value, key) {
					console.log("key : "+key);
					console.log("value : "+value);
					console.log("size : "+Object.keys($scope.apiDetails).length);
					if(Object.keys($scope.apiDetails).length < 4 || value==undefined || value==""){
						$scope.flag = true;
						$scope.msg = "fill all fields!";
					}else{
						if(key=="api" && value[0]!="/"){
							$scope.flag = true;
							$scope.msg = "API must be start with slash";
						}
						if(key=="requestMethod" && $scope.allMethods.indexOf(value)==-1){
							$scope.flag = true;
							$scope.msg = "request method must be from the drop down";
						}
						if(key=="statusCode" && !angular.isNumber(value)){
							$scope.flag = true;
							$scope.msg = "only numbers allowed";
						}
						if(key=="response"){
							try {
								console.log("inside response : "+JSON.parse(value));
							      JSON.parse(value);
							    } catch (e) {
							      $scope.flag = true;
							      $scope.msg = "Please enter valid json";
							    }
						}
					}
				}, $scope.log);
				}
				
				if(!$scope.flag){
					var req = {
							 method: 'POST',
							 url: '/cherry/add',
							 data: $scope.apiDetails
							}

							$http(req).then(function(){
								console.log("success");
								//$window.location.reload();
								console.log($scope.mockedResponses);
								if($scope.mockedResponses == null){
									$scope.mockedResponses = [$scope.apiDetails];
								}else{
									$scope.mockedResponses.push($scope.apiDetails);
								}
								$scope.apiDetails={};
							}, function(){
								console.log("failed")
								});
				}else{
					console.log("flag is "+$scope.flag);
				}
			}
			
			$scope.editApiDetails = function(details){
				
				var req = {
						 method: 'POST',
						 url: '/cherry//remove',
						 data: details
						}

						$http(req).then(function(){
							console.log("success");
							console.log(details);
							$scope.mockedResponses.splice($scope.mockedResponses.indexOf(details), 1);
							details.statusCode = parseInt(details.statusCode);
							console.log(details);
							$scope.apiDetails = details;
						}, function(){
							console.log("failed")
							});
			}
		});
	</script>

</body>
</html>